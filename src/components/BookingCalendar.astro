---
interface Props {
  title?: string;
}

const { title = "Termin buchen" } = Astro.props;
---

<link rel="stylesheet" href="/booking-calendar.css" />
<link rel="stylesheet" href="/booking-calendar-custom.css" />

<section class="booking-section animate-on-scroll" id="calendar-section">
  <div class="booking-container">
    <h2 class="booking-title">{title}</h2>
    <div id="bookingCalendar" class="booking-calendar"></div>

    <!-- Buchungsformular -->
    <div id="bookingForm" class="booking-form hidden">
      <h3>Buchung bestätigen</h3>
      <div class="booking-details">
        <p><strong>Datum:</strong> <span id="selectedDate"></span></p>
        <p><strong>Uhrzeit:</strong> <span id="selectedTime"></span></p>
        <p>
          <strong>Verfügbare Plätze:</strong>
          <span id="availableCapacity">-</span>
        </p>
      </div>

      <form id="bookingFormElement">
        <div class="form-group">
          <label for="name">Name *</label>
          <input type="text" id="name" name="name" required />
        </div>

        <div class="form-group">
          <label for="email">E-Mail *</label>
          <input type="email" id="email" name="email" required />
        </div>

        <div class="form-group">
          <label for="phone">Telefon</label>
          <input type="tel" id="phone" name="phone" />
        </div>

        <div class="form-group">
          <label for="participants">Anzahl Personen *</label>
          <input
            type="number"
            id="participants"
            name="participants"
            min="1"
            max="15"
            value="1"
            required
          />
        </div>

        <div class="form-group">
          <label for="notes">Anmerkungen</label>
          <textarea id="notes" name="notes" rows="3"></textarea>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" id="backToCalendar"
            >Zurück</button
          >
          <button type="submit" class="btn btn-primary"
            >Verbindlich buchen</button
          >
        </div>
      </form>
    </div>

    <!-- Erfolgs-/Fehlermeldung -->
    <div id="message" class="message hidden"></div>
  </div>
</section>

<style>
  .booking-section {
    padding: var(--space-12) var(--gutter);
    background-color: var(--color-background);
  }

  .booking-container {
    max-width: 900px;
    margin: 0 auto;
  }

  .booking-title {
    font-family: var(--font-serif);
    color: var(--color-clay-brown);
    text-align: center;
    margin-bottom: var(--space-8);
    font-size: 2rem;
  }

  .booking-calendar {
    background: var(--color-off-white);
    border-radius: var(--radius);
    padding: var(--space-6);
    box-shadow: var(--shadow-md);
  }

  .booking-form {
    background: var(--color-off-white);
    border-radius: var(--radius);
    padding: var(--space-6);
    box-shadow: var(--shadow-md);
    margin-top: var(--space-6);
  }

  .booking-form h3 {
    font-family: var(--font-serif);
    color: var(--color-clay-brown);
    margin-bottom: var(--space-4);
  }

  .booking-details {
    background: var(--color-warm-beige);
    padding: var(--space-4);
    border-radius: var(--radius);
    margin-bottom: var(--space-6);
  }

  .booking-details p {
    margin-bottom: var(--space-2);
  }

  .form-group {
    margin-bottom: var(--space-4);
  }

  .form-group label {
    display: block;
    margin-bottom: var(--space-2);
    font-weight: 500;
    color: var(--color-clay-brown);
  }

  .form-group input,
  .form-group textarea {
    width: 100%;
    padding: var(--space-3);
    border: 2px solid var(--color-warm-beige);
    border-radius: var(--radius);
    font-family: var(--font-sans);
    transition: border-color var(--duration-normal) var(--easing);
  }

  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--color-clay-brown);
  }

  .form-actions {
    display: flex;
    gap: var(--space-3);
    justify-content: flex-end;
    margin-top: var(--space-6);
  }

  .hidden {
    display: none !important;
  }

  .message {
    margin-top: var(--space-6);
    padding: var(--space-4);
    border-radius: var(--radius);
    text-align: center;
  }

  .message.success {
    background-color: #d1fae5;
    color: #065f46;
  }

  .message.error {
    background-color: #fee2e2;
    color: #991b1b;
  }

  /* Mobile Optimierungen */
  @media (max-width: 374px) {
    .booking-section {
      padding: var(--space-8) var(--gutter);
    }

    .booking-title {
      font-size: 1.5rem;
      margin-bottom: var(--space-6);
    }

    .booking-calendar,
    .booking-form {
      padding: var(--space-4);
    }

    .form-group label {
      font-size: 0.9375rem;
    }

    .form-group input,
    .form-group textarea {
      padding: var(--space-2);
      font-size: 0.9375rem;
    }

    .form-actions {
      flex-direction: column;
      gap: var(--space-2);
    }

    .form-actions button {
      width: 100%;
    }
  }

  @media (min-width: 375px) and (max-width: 639px) {
    .booking-section {
      padding: var(--space-10) var(--gutter);
    }

    .booking-title {
      font-size: 1.75rem;
    }

    .booking-calendar,
    .booking-form {
      padding: var(--space-5);
    }

    .form-actions {
      flex-direction: column;
      gap: var(--space-2);
    }

    .form-actions button {
      width: 100%;
    }
  }

  @media (min-width: 640px) and (max-width: 767px) {
    .booking-calendar,
    .booking-form {
      padding: var(--space-5);
    }
  }
</style>

<script>
  // Kalender-Initialisierung nach dem Laden der Seite
  document.addEventListener("DOMContentLoaded", async () => {
    // Prüfen ob BookingCalendar verfügbar ist
    if (typeof BookingCalendar === "undefined") {
      console.error("BookingCalendar ist nicht geladen");
      return;
    }

    // Lade verfügbare Termine vom Server
    let availableSlots = [];
    try {
      const response = await fetch('/api/slots');
      if (response.ok) {
        availableSlots = await response.json();
        console.log('Geladene Termine:', availableSlots);
      }
    } catch (error) {
      console.error('Fehler beim Laden der Termine:', error);
    }

    // Konvertiere Slots in das Format, das der Kalender erwartet
    const bookedSlots = availableSlots.map(slot => ({
      date: slot.date,
      time: slot.time,
      booked: slot.maxCapacity - slot.available,
      available: slot.available,
      maxCapacity: slot.maxCapacity,
      isFull: slot.available === 0,
      slotId: slot.id
    }));

    // Kalender initialisieren
    const calendar = new BookingCalendar("#bookingCalendar", {
      locale: "de",
      firstDayOfWeek: 1, // Montag
      minDate: new Date(),
      maxDate: new Date(new Date().setMonth(new Date().getMonth() + 3)),
      timeSlots: {
        enabled: true,
        start: "09:00",
        end: "20:00",
        duration: 120, // 2 Stunden
      },
      blockedDates: [],
      blockedWeekdays: [], // Keine festen Ruhetage mehr
      bookedSlots: bookedSlots,
      maxCapacityPerSlot: 15,
      onDateSelect: function (date, timeSlot) {
        showBookingForm(date, timeSlot);
      },
    });

    // Formular-Handler
    function showBookingForm(date, timeSlot) {
      document.getElementById("bookingCalendar").style.display = "none";
      document.getElementById("bookingForm").classList.remove("hidden");
      document.getElementById("selectedDate").textContent = formatDate(date);
      document.getElementById("selectedTime").textContent = timeSlot;

      // Datum im ISO-Format speichern (für API)
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const isoDate = `${year}-${month}-${day}`;

      // Versteckte Felder für API-Daten
      document.getElementById("selectedDate").dataset.isoDate = isoDate;
      document.getElementById("selectedTime").dataset.time = timeSlot;

      document.getElementById("availableCapacity").textContent = "15"; // Beispielwert
    }

    function formatDate(date) {
      return date.toLocaleDateString("de-DE", {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric",
      });
    }

    // Zurück-Button
    document.getElementById("backToCalendar")?.addEventListener("click", () => {
      document.getElementById("bookingForm").classList.add("hidden");
      document.getElementById("bookingCalendar").style.display = "block";
    });

    // Formular-Submit
    document
      .getElementById("bookingFormElement")
      ?.addEventListener("submit", async (e) => {
        e.preventDefault();

        const submitButton = e.target.querySelector('button[type="submit"]');
        const originalButtonText = submitButton.textContent;
        submitButton.disabled = true;
        submitButton.textContent = "Wird gesendet...";

        const formData = new FormData(e.target);
        const data = {
          date: document.getElementById("selectedDate").dataset.isoDate,
          time: document.getElementById("selectedTime").dataset.time,
          name: formData.get("name"),
          email: formData.get("email"),
          phone: formData.get("phone"),
          participants: formData.get("participants"),
          notes: formData.get("notes"),
        };

        console.log('Buchungsdaten:', data);

        const messageEl = document.getElementById("message");

        try {
          // API-Call zur Buchung
          const response = await fetch("/api/booking", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });

          const result = await response.json();

          if (response.ok && result.success) {
            // Erfolgsmeldung anzeigen
            messageEl.textContent =
              "Vielen Dank! Ihre Buchung wurde erfolgreich übermittelt. Sie erhalten in Kürze eine Bestätigungs-E-Mail mit Kalender-Eintrag.";
            messageEl.className = "message success";
            messageEl.classList.remove("hidden");

            // Formular ausblenden
            document.getElementById("bookingForm").classList.add("hidden");

            // Nach 5 Sekunden zurück zum Kalender
            setTimeout(() => {
              messageEl.classList.add("hidden");
              document.getElementById("bookingCalendar").style.display =
                "block";
              e.target.reset();
            }, 5000);
          } else {
            throw new Error(result.message || "Buchung fehlgeschlagen");
          }
        } catch (error) {
          console.error("Fehler bei der Buchung:", error);
          messageEl.textContent =
            "Es ist ein Fehler aufgetreten. Bitte versuchen Sie es später erneut oder kontaktieren Sie uns direkt.";
          messageEl.className = "message error";
          messageEl.classList.remove("hidden");

          setTimeout(() => {
            messageEl.classList.add("hidden");
          }, 5000);
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = originalButtonText;
        }
      });
  });
</script>

<script is:inline src="/booking-calendar.js"></script>
